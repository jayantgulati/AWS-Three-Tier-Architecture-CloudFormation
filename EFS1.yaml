Resources:
  MyEFS:
    Type: AWS::EFS::FileSystem
    
  EFSMount1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref MyEFS
      SecurityGroups:
        - '{{resolve:ssm:/parameters/stacks/security-groups/EFS/id}}'
      SubnetId: '{{resolve:ssm:/parameters/stacks/private-subnet-1/id}}'
      
  EFSMount2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref MyEFS
      SecurityGroups:
        - '{{resolve:ssm:/parameters/stacks/security-groups/EFS/id}}'
      SubnetId: '{{resolve:ssm:/parameters/stacks/private-subnet-2/id}}'


  Ec2Instance1:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.nano
      ImageId: '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
      Tags:
        - Value: EFS Testing
          Key: Name
      KeyName: pub 
      NetworkInterfaces: 
        - AssociatePublicIpAddress: True
          DeviceIndex: 0
          SubnetId: 
            '{{resolve:ssm:/parameters/stacks/public-subnet-1/id}}'
          DeleteOnTermination: True
          GroupSet:
            - '{{resolve:ssm:/parameters/stacks/security-groups/web-server/id}}'
      UserData: 
        Fn::Base64: 
          !Sub |
            #!/bin/bash
            sudo su
            yum update -y
            mkdir -p /var/www/html
            sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport ${MyEFS}.efs.ap-south-1.amazonaws.com:/ /var/www/html     
            sudo yum install -y httpd httpd-tools mod_ssl
            sudo systemctl enable httpd 
            sudo amazon-linux-extras enable php7.4
            sudo yum clean metadata
            sudo yum install php php-common php-pear -y
            sudo yum install php-{cgi,curl,mbstring,gd,mysqlnd,gettext,json,xml,fpm,intl,zip} -y          
            sudo rpm -Uvh https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm
            sudo rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
            sudo yum install mysql-community-server -y
            sudo systemctl enable mysqld
            sudo systemctl start mysqld
            sudo usermod -a -G apache ec2-user
            sudo chown -R ec2-user:apache /var/www
            sudo chmod 2775 /var/www && find /var/www -type d -exec sudo chmod 2775 {} \;
            sudo find /var/www -type f -exec sudo chmod 0664 {} \;
            chown apache:apache -R /var/www/html 
            wget https://wordpress.org/latest.tar.gz
            tar -xzf latest.tar.gz
            cp -r wordpress/* /var/www/html/
            cp /var/www/html/wp-config-sample.php /var/www/html/wp-config.php 
            service httpd restart    